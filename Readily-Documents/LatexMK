## 系统latexmk配置文件
## 文件名：LatexMK，文件目录: C:\latexmk\

# 设置 pdflatex,xelatex,bibtex,biber 选项执行的命令
# %O, %S 是占位符;
# %O 代表选项，%S 代表对应命令的源文件
$pdflatex = "pdflatex -shell-escape -file-line-error -halt-on-error -interaction=nonstopmode -synctex=1 %O %S";
$xelatex = "xelatex -shell-escape -file-line-error -halt-on-error -interaction=nonstopmode -no-pdf -synctex=1 %O %S";
$lualatex = "lualatex -shell-escape -file-line-error -halt-on-error -interaction=nonstopmode -synctex=1 %O %S";

# 解决使用-outdir 和 -auxdir 命令时无法找到.bib .bst 文件的问题
my $project_dir = getcwd(); # 获取当前项目所在路径
$bibtex = "bibtex -include-directory=\"$project_dir\" %O %S";
$biber = "biber -input-directory=\"$project_dir\" %O %S";

$xdvipdfmx = "xdvipdfmx -E -o %D %O %S";

# 编译索引
$makeindex = "makeindex -s gind.ist %O -o %D %S";

# 用glossaries做索引，所需要的额外编译
add_cus_dep('glo', 'gls', 0, 'glo2gls');
sub glo2gls {
    system("makeindex -s gglo.ist -o \"$_[0].gls\" \"$_[0].glo\"");
}
push @generated_exts, "glo", "gls";

# 用nomencl做索引，所需要的额外编译
add_cus_dep('nlo', 'nls', 0, 'nlo2nls');
sub nlo2nls {
    system("makeindex -s nomencl.ist -o \"$_[0].nls\" \"$_[0].nlo\"");
}
push @generated_exts, "nlo", "nls";



# 生成后缀fls的文件，该文件包含程序读写时的文件列表，1代表开启
$recorder = 1;

# 设置pdf预览器, 需要把下面的程序路径更换为自己电脑pdf阅读器的路径
$pdf_previewer = 'start "D:\\Application\\SumatraPDF\\SumatraPDF.exe" %O %S';

# 执行 latexmk -c 或 latexmk -C 时会清空 latex 程序生成的文件（-C 更强，会清空pdf）
# 除此之外, 可以设置额外的文件拓展，以进行清空
$clean_ext = "blg idx ind lof lot out toc acn acr alg glg glo gls ist fls log spl dtx nlo nls ilg glsdefs fdb_latexmk";


# 编译结束后自动删除Build下的所有文件夹
END {
    use strict;
    use warnings;
    use File::Path qw(remove_tree);

    my $build_dir = 'Build';

    # 检查Build文件夹是否存在
    unless (-d $build_dir) {
        die "Build directory does not exist.";
    }

    # 获取Build文件夹下的所有子文件夹
    opendir(my $dh, $build_dir) or die "Cannot open directory: $!";
    my @sub_folders = grep { -d "$build_dir/$_" && ! /^\.{1,2}$/ } readdir($dh);
    closedir($dh);

    # 删除所有子文件夹
    foreach my $sub_folder (@sub_folders) {
        remove_tree("$build_dir/$sub_folder");
    }

    print "All sub-folders in Build directory have been deleted.\n";
}


